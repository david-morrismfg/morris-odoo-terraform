# Morris Manufacturing Odoo Infrastructure

This repository contains the Infrastructure as Code (IaC) configuration for deploying Odoo ERP system on Linode cloud infrastructure with Cloudflare DNS management.

## Architecture Overview

The infrastructure consists of:

- A dedicated Linode instance (g6-dedicated-16)
- Block storage volume for Odoo data persistence
- VPC network for enhanced security
- Cloudflare DNS configuration for both production and development domains
- Automated Ansible configuration for application deployment

### Components

#### Compute Resources
- **Linode Instance**: g6-dedicated-16 running Ubuntu 22.04
- **Region**: US Central (Chicago)
- **Storage**: 50GB additional block storage mounted at `/odoo`
- **Network**: Dual-network setup with public and private VPC interfaces

#### Network Configuration
- **VPC**: Dedicated VPC network (10.0.4.0/24)
- **DNS**: Managed through Cloudflare
  - Production domain: morriserp.com
  - Development domain: morriserp.dev

#### Application Stack
- Docker for containerization
- Traefik as reverse proxy
- PostgreSQL for database
- Odoo ERP system

## Directory Structure

```
.
├── ansible.tf           # Ansible inventory and configuration generation
├── dns.tf              # Cloudflare DNS configuration
├── linode.tf           # Linode infrastructure configuration
├── terraform.tf        # Terraform and provider configuration
├── variables.tf        # Variable definitions
└── terraform.tfvars    # Secret variables (git-ignored)
```

## Ansible Configuration Details

The Ansible configuration (generated by terraform) sets up the following components:

### Base Configuration
- System time synchronization
- Docker installation
- Python requirements
- Container registry authentication for ghcr.io

### PostgreSQL Configuration
- Optimized for Odoo workloads with the following settings:
  - Max connections: 1000
  - Shared buffers: 8GB
  - Effective cache size: 24GB
  - Maintenance work mem: 2GB
  - Work mem: 24MB
  - Parallel worker configuration for optimal performance

### Traefik Configuration
- SSL certificate management through Let's Encrypt
- Automatic HTTP to HTTPS redirection
- Docker integration for service discovery

### Odoo Configuration
- Multi-database support with separate configurations for:
  - Production (morris-erp database)
  - Development (morris-dev database)
- Resource limits:
  - CPU time limit: 360s
  - Real time limit: 720s
  - Request limit: 8192
- Worker configuration:
  - 25 worker processes
  - Gevent port: 8072
  - Max cron threads: 1
- Proxy mode enabled with server-wide modules for web and database filtering

## Deployment

### Prerequisites
1. Terraform installed locally
2. SSH key pair for server access
3. Required API tokens:
   - Linode API token
   - GitHub Personal Access Token (for container registry)
   - Cloudflare API token

### Required Variables
Create a `terraform.tfvars` file with the following variables:
```hcl
odoo_password = "your_odoo_admin_password"
root_password = "your_root_password"
github_pat    = "your_github_pat"
```

### Deployment Steps
1. Initialize Terraform:
   ```bash
   terraform init
   ```

2. Review the deployment plan:
   ```bash
   terraform plan
   ```

3. Apply the configuration:
   ```bash
   terraform apply
   ```

4. Run the generated Ansible playbook:
   ```bash
   cd ansible-playbook
   ansible-playbook -i inventory/hosts site.yml
   ```

## Security Notes

1. All sensitive information is stored in `terraform.tfvars` which should never be committed to version control
2. VPC network isolates database traffic
3. Cloudflare provides DDoS protection and WAF capabilities
4. SSH access is restricted to key-based authentication
5. Database access is limited to the VPC network

## Maintenance

### Backups
While instance backups are disabled by default, it's recommended to implement application-level backups through Odoo's backup feature or custom scripts.

### Monitoring
Basic monitoring is configured through Linode's built-in monitoring with alerts for:
- CPU usage > 90%
- IO operations > 10000/s
- Network traffic spikes
- Transfer quota at 80%

### Scaling
The infrastructure can be scaled by:
1. Modifying the instance type in `linode.tf`
2. Adjusting the PostgreSQL configuration in `ansible.tf`
3. Modifying Odoo worker configuration based on load

## Support

For issues or questions, contact:
- Infrastructure: DevOps team
- Application: Odoo support team
